# 什么是共识

我们所说的共识，是指达成了广泛的一致。对于以太坊区块链来说，达成共识的过程是标准化的，达成共识意味着全网络中至少 66% 的节点就网络的全局状态达成一致。

# 什么是共识机制？
共识机制是一整套由协议、激励和想法构成的体系，使得整个网络的节点能够就区块链状态达成一致。
以太坊采用基于权益证明的共识机制，其加密经济的安全性来自于对质押人的锁定资本实施的一系列奖励和罚没措施。 这种激励体系鼓励各个质押人诚信运行验证者节点，并惩罚那些有不良行为的质押人，让攻击网络的行为付出极其高昂的代价。
还有一个协议，用于规范如何选择诚实的验证者，让它们提议或验证区块、处理交易并投票支持其链头部的视图。 **极少数情况下，如果链头部附近的同一位置存在多个区块，就会利用一个分叉选择机制来选择区块组成“最重的”链。区块权重根据为相应区块投票的验证者数量进行计算，并由验证者质押的以太币余额进行加权。**

# 什么是权益证明？
权益证明是构成共识机制的基础，区块链使用这些机制来实现分布式共识。 在工作量证明共识机制中，矿工通过消耗能源来证明他们拥有资本以应对风险。 以太坊采用权益证明机制，在该机制下，验证者明确地通过以太币将资本质押到以太坊上的智能合约中。 这些质押的以太币充当抵押品，如果验证者有失信行为或者消极怠工，那么可以销毁抵押品。 之后，验证者负责检查在网络上传播的新区块是否有效，并偶尔自己也创建和传播新区块。

# 验证者
要想作为验证者参与，用户必须向存款合约存入 32 个以太币并运行三种独立的软件：执行客户端、共识客户端和验证者。 存入以太币时，用户会进入一个激活队列，限制新验证者加入网络的速度。 激活后，验证者将从以太坊网络上的对等节点接收新区块。 区块中交付的交易会被重新执行，并且对区块签名进行检查以确保区块是有效的。 然后验证者在整个网络上发送支持该区块的投票（称为认证）。
权益证明以太坊中的时间分为时隙（12 秒）和时段（32 个时隙）。 在每个时隙中随机选择一位验证者作为区块提议者。 该验证者负责创建新区块并发送给网络上的其他节点。 另外在每个时隙中，都会随机选择一个验证者委员会，通过他们的投票确定所提议区块的有效性。

# 最终确定性
交易在分布式网络具有“最终确定性”是指，该交易是区块的一部分且无法改变，除非燃烧掉大量以太币。 在权益证明以太坊上，通过“检查点”区块来管理确定性。 每个时段中的第一个区块是检查点。 验证者为他们认为有效的“检查点对”投票。 如果一对检查点获得了质押以太币总数中三分之二以上的投票，那么这对检查点将被升级。 这两个检查点中较新的一个会变成“合理”状态。 较旧的一个检查点已经是合理状态，因为它是上一个时段中的“目标”。 现在，这个检查点会升级为“已确定”状态。 要回滚最终确定的区块，攻击者将承担至少相当于质押以太币总数三分之一的损失。因为最终确定性需要获得三分之二多数投票，攻击者可以用质押以太币总数的三分之一投票来阻止网络实现最终确定性。 有一种可以防御这种攻击行为的机制：怠惰惩罚。 当链超过四个时段无法最终确定时，这项机制会触发。 怠惰惩罚逐渐消耗与大多数投票相反的验证者的质押以太币，使得大多数验证者重新获得三分之二多数投票并最终确定链。

# 加密经济的安全性
运行验证者是一种承诺。 验证者应当保持足够的硬件和连接，来参与区块的验证和提出。 作为回报，验证者将获得以太币（他们的质押余额增加）。 另一方面，作为验证者参与，也为用户为了个人利益或破坏而攻击网络开辟了新的渠道。 为了防止这种情况，如果验证者在被调用时未能参与，他们就会错过以太币奖励；如果他们有不诚实行为，他们现有的质押可能会被销毁。 主要有两种行为被视为不诚实：在一个时隙中提出多个区块（模棱两可）和提交相互矛盾的认证。 被罚没以太币的金额取决于大致同一时间受到罚没的验证者数量。 这称为“相关惩罚”，相关惩罚可以是轻微的（单个验证者被罚没质押以太币的 1%），也可以导致验证者质押的以太币全部被销毁（大额罚没事件）。 这种惩罚在强制退出期执行，首先是第 1 天的立即处罚（最多 0.5 个以太币），接着是第 18 天的相关惩罚，最后是第 36 天的逐出网络。 如果验证者在网络上但不提交投票，他们每天都会受到轻微的认证惩罚。 对于攻击者来说，这些措施都意味着协同攻击的代价将极其高昂。

# 分叉选择
当网络以最佳状态诚信运行时，链头始终只会有一个新区块并且所有验证者都会证明它。 然而，由于网络延迟或因为区块提议者提议多个区块（模棱两可），验证者可能看到不同的链头视图。 因此，共识客户端需要一种算法来确定支持哪一个区块。 权益证明以太坊中使用的算法称为 **LMD-GHOST**。它的工作原理是**确定其历史记录中具有最大证明权重的分叉**。

# 权益证明和安全性
正如在工作量证明中一样，权益证明中仍然存在 51% 攻击的威胁，但对于攻击者来说风险却更大。攻击者需要获得 51% 的质押以太币。然后他们可以通过自己的认证确保他们首选的分叉拥有最多累积认证。共识客户端使用累积认证的“权重”确定正确的链，所以攻击者能够使他们的分叉成为规范区块。然而与工作量证明相比，权益证明的优势在于，社区能够灵活地发动反击。例如，诚实的验证者可以决定继续在非主流链上构建并忽略攻击者的分叉，同时鼓励应用程序、交易所和池也这样做。 他们还可以决定强行将攻击者从网络中移除并销毁攻击者质押的以太币。这些都是对 51% 攻击的强有力的经济防御措施。

51% 攻击只是其中一种恶意行为。 不良行为者可能会尝试远程攻击（尽管最终确定性小工具抵消了这种攻击向量）、短程“重组”（尽管提议者权重提升和认证期限可以缓解这种情况）、弹跳攻击和平衡攻击（也可以通过提议者权重提升来缓解，并且这些攻击只能在理想化的网络条件下演示）或雪崩攻击（被只考虑最新消息的分叉选择算法规则抵消）。

# 女巫攻击防御和链选择规则

女巫攻击是指一个用户或用户群体假装成许多用户。防御这种攻击对去中心化区块链至关重要，并使矿工和验证者能够在资源投入的基础上获得平等奖励。通过让用户消耗大量能源或提供大量抵押品，工作量证明和权益证明可以防止这种情况。这些保护措施通过经济手段对女巫攻击形成威慑。
链选择规则用于决定哪条链才是“正确”的。 对于工作量证明链，最长链由链上累积的工作量证明总难度决定。 以太坊曾经也使用过最长链规则；然而权益证明机制下运行的以太坊采用了经过更新的分叉选择算法，衡量链的“权重”。权重是验证者投票的累积总数，并以验证者质押的以太币余额加权。

以太坊使用被称为 Gasper 的共识机制，该机制结合了 Casper 友好的最终确定性工具权益证明和 GHOST 分叉选择规则。

## Gasper
### 作用
节点提供以太币作为安全保证金，但如果他们在提议或验证区块链时过于懒惰或不诚实，保证金就会被销毁。Gasper 是一种定义验证者如何受到奖惩的机制，决定要接受和拒绝哪个区块，以及将区块建在哪个区块链分叉上。
### 最终确定性
“最终确定性”，意味着除非出现严重的共识失败，且攻击者至少销毁了总质押以太币的 1/3，否则这些区块将不能回滚。区块必须完成“两步走”升级程序才能最终确定下来。

区块必须获得总质押以太币 2/3 的投票，才能纳入权威链。此条件可将区块升级至“合理”状态。合理的区块不大可能回滚，但满足某些条件时也可以回滚。
当一个合理区块上有另一个区块被合理化，那前者就被升级为“最终确定”状态。确定一个区块就是承诺将该区块纳入权威链。
并非每个时隙都会发生这种区块升级。只有时段边界的区块才能是“合理”和“最终确定”状态。 这些区块一般被称为“检查点”。 升级涉及成对的检查点。 两个连续的检查点之间必须存在"绝对多数链接"（即：总质押以太币中有 2/3 投票认为检查点 B 是检查点 A 的正确衍生物），才能将存在时间更长的检查点升级为“最终确定”，而较新的区块则升级为“合理”。

由于最终确定需要三分之二同意某个区块是规范的，因此除非能满足以下条件，否则攻击者不可能另外创建一条最终确定链：
拥有或控制总质押以太币的 2/3。
至少销毁总质押以太币的 1/3。
之所以要满足第一个条件，是因为要最终确定一条链，需要质押以太币 2/3 的投票。 而第二个条件是因为，如果总质押的 2/3 对两个分叉表示支持，那么必然有 1/3 对两个分叉均进行了投票。 双重投票是会触发最大惩罚的罚没条件，总质押的 1/3 会被销毁。 截至 2022 年 5 月，此条件需要攻击者销毁价值约 100 亿美元的以太币。 Gasper 中用来合理化和最终确定区块的算法是友好的最终确定性工具 Casper (Casper-FFG) 的微调版。

#### 激励和罚没
验证者将因诚实地提议和验证区块而获得奖励。奖励将以发放以太币的形式提供，这些以太币将加入他们的质押额。另一方面，缺席和调用时未能响应的验证者将会错过这些奖励，有时还会损失一小部分现有质押额。离线的处罚较小，在大多数情况下，仅仅是错失奖励的机会成本。恶意行为，例如，为同一时隙提议多个区块、为同一时隙验证多个区块或者与以前的检查点投票背道而驰。这些都是要接受更严厉惩罚的“可罚没”行为，罚没结果是验证者的部分质押额遭到销毁，以及验证者被移出验证者网络。整个过程需要 36 天。第一天，进行最高 0.5 以太币的初次罚款。随后，被罚没验证者的以太币将在退出期一点点耗尽，到第 18 天，会收到一个“相关惩罚”，即当更多的验证者都在大致相同的时间受罚时，惩罚将更重。最大的惩罚是永久质押。这些奖励和惩罚为激励诚实的验证者和挫伤网络攻击而立。

#### 不作为惩罚
除了安全性，Gasper 还提供“可靠活性”。条件是只要有三分之二的质押以太币遵守协议地诚实投票，不论是否发生其他任何活动（比如攻击、延迟问题或罚没），区块链都将被最终确定。换言之，要阻止区块链被最终确定，必须以某种方式破坏总质押以太币的 1/3。在 Gasper 中，有另一条防线防止活性失败，即“不作为惩罚”。如果链未能在四个时段内最终确定，便会激活此机制。对于未能积极证明主链的验证者，其质押货币将逐渐耗尽，直到主链重新获得总质押 2/3 的投票，以确保活性失败只是暂时的。

#### 分叉选择
Casper-FFG 的原始定义包含一个分叉选择算法，该算法规定：follow the chain containing the justified checkpoint that has the greatest height，其中高度被定义为与创世区块之间的最大距离。在 Gasper 中，原来的分叉选择规则被弃用，转而采用一种更复杂的算法，即 LMD-GHOST。正常情况下，分叉选择规则是不必要的 - 每个时隙都有一个区块提议者，并有诚实的验证者证明此区块。只有在网络异步性较大或不诚实的区块提议者模棱两可的情况下，才需要分叉选择算法。当这些情况出现时，分叉选择算法是确保正确链的关键防御。
LMD-GHOST 代表“最新消息驱动的最贪婪、最重的观测子树（Latest Message-Driven Greedy Heaviest Observed Sub-Tree）”。该术语充满行话，用来定义一种算法：选择具有最大证明累积权重的分叉作为权威分叉（最贪婪、最重的子树）；如果从验证者那里收到多条消息，则只考虑最新的那个（最新消息驱动）。在将最重的区块添加到权威链之前，每位验证者都会使用这个规则来评估每个区块。

## 扩展方案

### 增加每个区块的大小
扩展区块链的最早想法之一就是简单地增加每个区块的大小。更大的区块意味着更难以被处理，并且往往会导致更高的延迟，这对以太坊网络是不利的。更大的区块大小也意味着需要更多的存储空间，这就会增加每个网络节点所需的容量。更大的区块将使节点更难以与网络同步。

### 使用很多不同的山寨币网络来减轻主链的负载，从而试图增加网络的扩展性
代价是使网络的安全性受到损害。

### “混合挖矿” (merge mining)
混合挖矿就是试图通过将主链的负载转移至几条不同的侧链上，从而减轻主链的负载并增加吞吐量。所有采用混合挖矿的区块链网络都有着相同的矿工和挖矿协议，(或者在 PoS 系统中，有着相同的验证者)。这种方式增加了潜在攻击的成本，因此使得这种方式比使用很多山寨币的方式更加安全。但是网络吞吐量增加 N 倍，意味着网络中的挖矿能力也需要增加 N 倍，这就会导致同样的挖矿中心化风险。


上诉三种方式并不是解决区块链不可能三角的理想解决方案，因此并没有被以太坊2.0团队所接受。

其中一种方案涉及到使用诸如 ZK-SNARKs 或 Mimblewimble 等先进的密码学技术来加快节点的验证速度。这种系统在链上创建能够使各个节点更快更容易地对区块进行验证的区块密码学证明 (cryptographic proofs)，这种方式使得节点只需验证区块的密码学证明，而无需从创始区块开始验证整条链。尽管如上这些方案可能带来交易速度的提升，但它们并不是完整的扩展方案。


### Plasma 链
通过实现在区块链之间 (比如以太坊主链和 Plasma 链之间) 进行资产的相互转移来增加带有智能合约功能的区块链的吞吐量。交易就从以太坊主链上被委托到了 Plasma 链上，从而使主要节点可以以一种更具成本效益和更合理的方式来分配计算能力。Plasma 链是相对安全的，Plasma 链甚至包含了“回滚”的功能。缺点：通过使用 Plasma 链只能有限地扩展以太坊网络，而无法以指数方式扩展。另外 Plasma 链并不像以太坊主链本身那样那么安全。这种方案的最大特点就是 Plasma 与 Sharding 并非相互排斥的。

### 状态通道
另一种以太坊链下扩展方案就是基于通道的策略来实现扩展，比如比特币的闪电网络或者以太坊的雷电网络。状态通道 (state channels) 具有许多与 Plasma 链相同的优点和权衡，但在技术层面上的操作却截然不同。与 Plasma 链一样，状态通道也是与 sharding 具有互补性的。

## Sharding


# Prysm

validator、beacon chain、slasher(optional)

## 网络设计

初始化同步
在网络设计的这个迭代中，验证器与空数据库的初始同步将类似于以太坊 1.0 的同步工作流程，其中节点从创世事件开始同步。初始同步的工作流程如下：
1. 通过从工作量证明以太坊节点读取 ETH1 存款合约日志来确定创世状态和区块。
2. 从创世到最后一个确定的纪元，与 N 个对等方进行循环批处理块同步。
3. 在收到每个完整纪元后处理批处理块。
4. 在与最终纪元中的最后一个块同步后，验证根是否与最终纪元上收到的信息对齐。
5. 使用分叉选择规则继续与最高对等点同步，然后恢复常规网络同步。

进行第4步的理由是，我们保证在到达最终纪元之前不会有分叉或运行分叉选择规则。在那之后，我们必须运行分叉选择规则来确定链头。

## validator

### 提出信标块
一个区块提案必须包括几个步骤，以满足协议验证的最低要求。按时间顺序，这些步骤是：
规范头块从信标节点获取，其根用作新块的父根。
提取所有尚未包含在链中的待定存款。
获取用于对存款对象进行投票的 ETH1 数据。
获取所有未决的罚没和验证者自愿退出。
检索来自信标链的最新分叉数据。
randao reveal 由 BLS 签署纪元生成。
获取来自信标节点的所有待定证明。
块对象是通过将上述项目打包成一个块数据结构来构建的。
计算状态根哈希，使用验证者的私钥对块进行签名。
该块是通过 gRPC 将其发送到信标节点来提议的。

### 证明信标块
证明一个块是一个类似于提议的过程，尽管有一些稍微不同的步骤：
组装证明数据结构并获取验证器的分配分片。
向信标节点请求证明块所需的信息。
使用验证器索引构造证明位域。
然后使用验证者的私钥对证明密钥进行签名。
在时隙持续时间的中途，证明通过 gRPC 发送到信标节点。

### 生命周期
![validator-lifecycle](assets/03/validator-lifecycle.png)

#### 未知状态（UNKNOWN）
当Prysm验证器客户端加载尚未向以太坊工作量证明链的验证器存款合约提交有效存款的验证器密钥时，此时会报告验证者的状态为 UNKNOWN 。
#### 已存款状态（DEPOSITED）
一旦将有效交易提交给验证者存款合约，信标节点将检测到 ETH1 链上交易的存在，此时会报告验证者处于已存款状态。
#### 处理中状态（PENDING）
当前处理存款的规范需要ETH1_FOLLOW_DISTANCE（最少 2048 个 ETH1 区块，约 8 小时，以确保链的稳定性）加上EPOCHS_PER_ETH1_VOTING_PERIOD（64 个纪元，约 6.8 小时，以组织一个规模庞大的委员会进行投票），然后才能将存款处理成以太坊信标链。然后为验证器分配一个索引号并放入队列中以进行激活。信标链每个确定的 epoch 可以处理 4 ~ 16 个新验证者的存款，数量的差异由链上的活跃验证者总数决定。一旦验证者到达队列的前端，它会在另外 4~5 个时期（约 31 分钟）后被分配一个激活时期。
#### 激活状态（ACTIVE）
一旦激活时期到来，验证者就会被激活并分配职责，包括提议或证明信标链上的区块。验证者根据他们的整体表现获得初始存款的奖励或惩罚。如果验证者的余额低于 16 ETH（通常是由于不活跃），它将被驱逐。驱逐被视为与自愿退出相同。
#### 削减状态（SLASHING）
如果在验证器处于活动、退出或退出状态时块中包含可罚没事件，它将短暂进入 SLASHING 状态，在该状态下应用罚没，然后强制转换为 EXITED 状态。被罚没的验证者会受到三种不同的惩罚：

最低惩罚
立即发出（1/32 *有效余额）的罚款

遗漏证明惩罚
与不活跃的验证者产生的惩罚相等的惩罚，在验证者离开退出队列之前的每个时期发出

攻击倍数惩罚
惩罚与过去 8192 个时期（4 周，约 36 天）中其他削减次数的三倍成正比，在削减事件首次包含在块中后应用 4096 个时期（2 周，约 18 天）。在正常情况下，这个惩罚很小，但是如果在短时间内发生大量削减，这个惩罚可能高达 32 ETH。

#### 提款状态（Withdrawals）
已激活并具有验证器索引的验证器（包括被削减/退出的验证器）可以发起BLStoExecutionChange请求，该请求更改其withdrawal_credentials开始撤回流程的时间。一旦withdrawal_credentials更改，取款将自动以每块 16 笔的速度处理。一旦发起取款，完全退出的验证者也将完全退出。

#### 退出状态（EXITING）
一个 ACTIVE 验证者可以通过向以太坊网络提交一个签名的VoluntaryExit操作来请求退出。假设验证者处于活动状态SHARD_COMMITTEE_PERIOD 或者 256 个时期 ~ 27 小时加上前瞻 4~5 个时期（~31 分钟），验证者将被分配一个由退出队列的长度决定的 exit_epoch。信标链每个确定的 epoch 可以处理 4 ~ 16 个验证者的退出，数量的差异由链上的活跃验证者总数决定。
#### 已退出状态（EXITED）
在验证者自愿进入退出状态的情况下，资金将在 256 个纪元（约 27 小时）后可提取。如果验证者被削减，这个延迟会延长到 4 周（2048 纪元*4 或 ~36 天）。如果在提取资金之前块中包含可罚没事件，则验证器将返回 SLASHING 状态，从而导致提款延迟重置。

# Reference

https://ethereum.org/zh/developers/docs/consensus-mechanisms/


