# 扩容方案

## 链上扩容

链上扩容方案，指的是通过对于原链的设计进行更改，以达到扩容效果的方案。区块链技术可以拆成六大层级结构：共识层、网络层、数据层、激励层、合约层、应用层。其中前三个是区块链的底层基础，也是链上扩容方案操作的目标。

### 共识层：中本聪共识、BFT类共识、混合共识（主链PoW侧链PoS）

共识机制，指的是区块链中各个节点对于数据的可用性以及账本状态的一致性达成共识的过程。由于共识机制完全决定了从下载数据到打包出块的整个流程，因此节点对于交易的验证效率严重依赖于共识机制的设计。

### 数据层：扩块、缩数据、DAG

每个区块中可以打包的交易数量也与交易的吞吐量密切相关。我们可以通过扩大区块容量、缩小交易数据的方式提升区块链吞吐，或是直接采用 DAG 的数据结构来处理交易。

放宽/取消区块大小限制
    扩大区块容量，可以使得每个区块中打包进更多笔交易数据，但是同时会使区块广播的时间增加，提升网络延迟，从而增加硬分叉的风险。

缩小区块中储存的数据
    此类方案中，较为出名的有 Segwit 隔离见证：将区块信息中签名的部分以及用于计算交易 ID 的数据进行单独管理，从而压缩60%的交易信息量。作为缓解容量问题的辅助方案较为有效，但是不能解决本质问题。

DAG（Directed Acyclic Graph 有向无环图）
    区块链采用链式结构，其区块头中只能包含一个区块的哈希值；DAG 结构下的区块头中可以包含多个区块的哈希值；区块链中新的区块会被添加到链的最后端，不能从链中间续写；DAG 可以从之前的区块续写。
    
    区块链是同步记账，节点需要在同一时间记录同样的信息；DAG 是异步记账，同一时间内不同的节点可以记录不同的信息。因此 DAG 单位时间内可以打包的交易数量更多，TPS 极高。基于 DAG 的协议目前主要有 SPECTRE 和 PHANTOM 两种。

### 网络层：分片

分片指的是将账本拆分成若干个部分，分别由不同的节点集团进行管理。通过实施状态分片，每个节点需要处理的交易数据变少，不仅可以提升交易处理速度，并且对于节点的性能需求也会相对降低，使得参与挖矿的门槛降低，去中心化程度加强。

#### Sharding 1.0

将n=64个数据碎片 blob 添加到信标链中，每个周期（epoch）内有n个验证节点广播自己的数据碎片 blob，并由委员会对于数据的真实性与可用性进行确认，确认完成后的 blob 被加入执行链。每经过一个 epoch 重新分配各个分片链所对应的验证者的机制，导致了分片链切换后数据同步不及时的问题，会造成延迟。此外，这种方式还面临着四个问题：无法保证信标链上的每个区块中写入了全部分片需要的交易数据；无法对于全部分片进行全局检查；验证节点可能导致 liveness failure；结合 PoS，只要钱够多，控制的节点够多，更容易控制委员会。在 ETH 发行率降低、验证集中化的背景下，此机制为 MEV 提供了机会。

#### DankSharding

为了规避 Sharding1.0 中的风险，DankSharding 提出了两个要点：所有 blob 都将被加入信标块；每个委员会的成员只对碎片数据的一个子集进行处理，所有信标数据和分片数据可以一起检查。
具体来说，Danksharding 的核心机制分为三部分：
**数据可用性抽样**：编码者使用 RS 编码进行冗余传输，减少节点的验证压力，同时采用 KZG 多项式承诺来保证编码正确。在此之上，通过将数据块的分片再次进行分片、并在不同数据块分片间重组的方式对 RS 编码进行二位扩展，降低全节点数据重构的门槛，从而降低中心化程度；
**出块者-打包者分离**：将全节点分成出块者和打包者两种角色，低配置的出块者负责去中心化选择打包者并获得打包者的竞价，具备高配置高性能的打包者则通过竞价获取打包记账权，从而解决 MEV 的价值分配问题；
**抗审查清单**：出块者指定合法的交易列表，打包者证明自己看到了列表并将列表中的交易包含在打包中，以此防止打包者故意忽略合法的交易。

#### Proto-Danksharding/EIP-4844

DankSharding 的机制实现起来较为困难，作为阶段性的方案，EIP-4844出现了。EIP-4844中引入了具有时效性的 blob，类似于移动硬盘，在被写入主网后，blob 只存在一段时间，随即被销毁。在 EIP-4844的设计中，同样引入了 KZG 多项式承诺，以确保后续 DankSharding 实装时可以向前兼容。


## 链下扩容

链下扩容方案，指的是在不改变原链构造的前提下，通过在主网之外进行交易处理，来减轻主网的处理压力。主要有状态通道、侧链、跨链和链下计算。

### 状态通道

状态通道指的是，在特定参与者之间通过多签等方式锁定区块链状态的一部分（打开通道）-> 针对通道中出现的状态转换，在所有参与者的同意下，在链下更新状态 -> 确认最终状态，并向主链广播。由于只需要广播最终状态，使用状态通道处理琐碎的相互交易可以有效减少主链上广播的交易数量，降低交易延迟。此外，每个参与者可以通过中介与其他没有打开通道的参与者互动。状态通道透明度低，通常只适用于在特定参与者之间发生的频繁交易。

### 侧链

侧链是完全独立于主链的区块链，其使用锁定+铸造/销毁的方式将资产从主链投影至侧链，并完全在侧链上完成交易处理与储存的整个流程。侧链的安全性完全依靠于其自身的节点以及共识机制。分为锚定式侧链与联邦侧链（在主链和侧链间增加多签地址用于验证交易，以降低延迟）两种。

### 跨链

跨链技术想要解决的范围会更广泛一些，它主要的目的是实现资产和状态等的跨链转移和交换，在跨链技术中链与链之间的关系不仅仅是主侧链的关系。




Rollup 与侧链的不同是，其仅在子链上处理交易，数据仍储存在主网上，因此可以在提升交易处理效率的同时享受主网的数据安全性。Rollup 按照数据可用性和交易验证方式可以分成四种：

### Rollup

### Plasma： 欺诈证明（检举无效交易）+ 链下DA（安全性-，扩容效果+）

Plasma 需要在主链上创建一个写入了子链哈希状态转换规则的智能合约，以此连接主链和子链（和孙子链、重孙链…）其扩容机制与状态通道类似，通过减少主链需要处理与保存的交易来提升吞吐，只是其在主链之外建立的并不是特定参与者之间的通道，而是共用的具备独立共识机制的新区块链，子链需要定期向主链上的智能合约提交状态更新，在顺利通过7天的质疑期（乐观证明，为了保证交易安全）后将区块状态写入主链。其集合了状态通道与侧链的优点：在状态通道模式下，如果需要增加新的参与者，需要在链上重新打开新的通道，而在 Plasma 中不需要；状态通道向主链同步状态时需要全部参与者的同意，而 Plasma 不需要；状态通道只保留最终状态，Plasma 的状态转换记录在子链上有完整的记录；侧链上的状态转换会直接影响到主链上的状态，因此其资产安全性取决于侧链本身，而 Plasma 并不是，其安全性依赖于主链。

Plasma 机制主要面临的问题是：子链节点需要保留子链上的大量交易数据；节点必须在线。

##### 有效性证明（推理交易有效）+ 链上DA（安全性+，扩容效果-）= ZK-Rollup

zkRollup 可以有效改善 Plasma 所面临的问题。由于这部分的 zkRollup 和 Validium 均使用零知识证明作为验证机制，因此在这部分先简单叙述一下零知识证明的概念：零知识证明，指的是在向其他人证明某个命题为真时，除了命题为真之外，不提供其他的信息佐证。在 zkRollup 中，使用 zkSNARK 对于大量的交易进行验证，确定了这些交易的有效性后，只需要向主网上传一个证明这些交易都有效的零知识证明即可。这样做大幅压缩了数据量，可以将交易数据写入主网。zkRollup 也面临着一些问题：零知识证明计算困难；初期需要信任；通用性较差。

### Validium： 有效性证明（推理交易有效）+ 链下DA（安全性-，扩容效果+）

Validium 同样使用零知识证明保证其交易信息的有效性与链下数据的可用性。其与 zkRollup 的唯一区别是，将数据可用性放到了链下，这使得 Validium 拥有了更高的吞吐量，但是带来的后果是数据可用性的管理者稍微修改 Merklized 状态，就可以让用户无法转移资金。在 zkRollup 出现后，Validium 基本上是完全失去了竞争力。

##### 欺诈证明（检举无效交易）+ 链上DA（安全性+，扩容效果-）= Optimistic Rollup

Optimistic Rollup 是 Plasma 的升级版，同时可以解决 zkRollup 通用性的问题。其默认节点提交的交易信息是正确的，向主网提交交易信息后，会有7天的质疑期，供他人检查交易的正确性。其与Plasma 的不同在于，将交易数据写入了链上；与 zkRollup 的不同在于，不使用零知识证明。在中和了其他两种 Rollup 的同时，Optimistic Rollup 也牺牲了部分的吞吐量。

### 链下计算

链下计算，意在通过将验证之外的功能全部移至链下的方式提升链上吞吐量。其主要需要保证安全性与隐私性，具体的操作方式可以分为可验证的链下计算、“飞地”型链下计算、链下安全多方计算和激励驱动型链下计算四种。

**可验证的链下计算**：zk-SNARKs，Bulletproofs，zk-STARKs

链下的证明者将链下的计算结果上链，并由链上的验证者进行检验。

**“飞地”型链下计算**：Enigma，Ekiden

在区块链节点上创建可信执行环境（Trusted Execution Environment，TEE）并预设数据接口进行计算。TEE 充当黑箱，可以在有效保护数据隐私的同时实现明文数据运算，提升计算效率。

**链下安全多方计算**

将数据拆分并分发给各个节点，节点根据当前区块链的状态以及各自获得的数据计算状态变化，将各个节点计算出的数据结合，即可获得完整的计算后数据。节点需要计算的数据更少，效率更高。

**激励驱动型链下计算**

求解者对于交易数据进行计算，在公布结果的同时质押保证金；验证者对于求解者的结果进行验算，如果发现错误，则可以质押保证金并发起链上仲裁，正确的一方将获得用户支付的手续费。



# Reference

https://www.bitpush.news/articles/3004698
https://vitalik.ca/general/2021/04/07/sharding.html

